import{U as e,k as t,x as n,az as o,a9 as a,M as i,o as s,c as l,a as r,t as d,f as c,Y as u}from"./@vue.js";const p=e=>e+"_"+(Date.now()+Math.floor(1e6*Math.random())),m=()=>{const e="undefined"!=typeof window?window:global;return e&&"tinymce"in e?e.tinymce:null};function g(e){return e?e.getContent():""}function f(e,t){t&&t.setContent(e)}function y(e,t=!0){e&&e.mode.set(t?"readonly":"design")}function b(e,t,n){return new Promise(((o,a)=>{let i,s,{images_upload_url:l,images_upload_credentials:r,custom_images_upload_header:d,custom_images_upload_param:c,custom_images_upload_callback:u,custom_images_limit_size:p}=e||{};if(p&&t.blob().size>p){let e="图片大小不能超过 ".concat(p/1024,"KB");a(e)}else i=new XMLHttpRequest,i.withCredentials=!!r,i.open("POST",l||""),d&&Object.keys(d).forEach((e=>{i.setRequestHeader(e,d[e])})),i.upload.onprogress=function(e){n(e.loaded/e.total*100)},i.onload=function(){if(403===i.status)return void a({message:"HTTP Error: "+i.status,remove:!0});if(i.status<200||i.status>=300)return void a("HTTP Error: "+i.status);let e=JSON.parse(i.responseText);if(!e)return void a("Invalid JSON: "+i.responseText);let t="function"==typeof u?u(e):e.location;t?o(t):a("Failed Path: location image path is error/empty")},i.onerror=function(){a("Image upload failed due to a XHR Transport error. Code: "+i.status)},s=new FormData,s.append("file",t.blob(),t.filename()),c&&Object.keys(c).forEach((e=>{s.append(e,c[e])})),i.send(s)}))}const v=(()=>{let e={status:{},loadedCallbacks:{}};const t=t=>{e.loadedCallbacks[t]&&(e.loadedCallbacks[t].forEach((e=>{"function"==typeof e.handler&&e.handler.call(e.scope)})),e.loadedCallbacks[t]=void 0)};return{load:(n,o,a)=>{o&&(e.loadedCallbacks[n]||(e.loadedCallbacks[n]=[]),e.loadedCallbacks[n].push({handler:o,scope:a||globalThis})),"LOADED"!==e.status[n]?"LOADING"!==e.status[n]&&(e.status[n]="LOADING",((e,t)=>{const n=document.createElement("script");n.id=p("tiny-script"),n.type="application/javascript",n.src=e,n.referrerPolicy="origin";const o=()=>{n.removeEventListener("load",o),t()};n.addEventListener("load",o),(document.head||document.body).appendChild(n)})(n,(()=>{e.status[n]="LOADED",t(n)}))):t(n)}}})(),_=["id"],h={key:0},C={name:"Vue3Tinymce"},k=Object.assign(C,{props:{modelValue:String,setting:{type:Object,default:()=>({})},setup:Function,disabled:Boolean,scriptSrc:String,debug:Boolean},emits:["update:modelValue","init","change"],setup(C,{expose:k,emit:O}){const w=C,E=O;let T=!0;const x=e({editor:null,id:p("tinymce"),err:""}),D=()=>{var e;return String(null!=(e=w.modelValue)?e:"")},j=(e,t,n)=>{w.debug&&console.log("来自：".concat(e.type," | \n ").concat(t," \n ").concat(n||"--"))},S=(e,t)=>{t||(t=x.editor);const n=g(t);j(e,n),E("update:modelValue",n),E("change",n)},L=()=>{var e;if(null===m())return void(x.err="tinymce is null");w.debug&&console.warn("vue3-tinymce 进入debug模式");let t={...w.setting,selector:"#".concat(x.id),content_style:(n=null==(e=w.setting)?void 0:e.content_style,"body{font-size: 14px;} img{padding: 0 2px;} "+(n||"")),setup:e=>{x.editor=e,w.setup&&w.setup(e),e.on("init",(()=>(e=>{f(D(),e),w.disabled&&"readonly"!==e.mode.get()&&y(e),e.on("change input undo redo",(t=>{S(t,e)})),E("init",e)})(e)))}};var n;w.setting.custom_images_upload&&(t.images_upload_handler=(...e)=>b.apply(null,[w.setting,...e])),m().init(t),T=!1};return t((()=>w.modelValue),((e,t)=>{if(x.editor&&x.editor.initialized&&t!==e&&e!==g(x.editor)){if(j({type:"propsChanged to setContent"},e,t),null===e)return function(e,t){if(t){if(t.resetContent)return t.resetContent(e);t.setContent(e),t.setDirty(!1),t.undoManager.clear()}}("",x.editor);f(D(),x.editor)}})),t((()=>w.disabled),(e=>{x.editor&&x.editor.initialized&&y(x.editor,e)})),k({id:x.id,editor:x.editor}),n((()=>{var e;if(null!==m())return void L();const t=null!=(e=w.scriptSrc)?e:"https://cdn.bootcdn.net/ajax/libs/tinymce/6.1.2/tinymce.min.js";v.load(t,L)})),o((()=>{T||L()})),a((()=>{var e;x.editor&&(null==(e=m())||e.remove("#".concat(x.id)))})),i((()=>{var e;x.editor&&(null==(e=m())||e.remove("#".concat(x.id)))})),(e,t)=>(s(),l(u,null,[r("div",{id:x.id,class:"tiny-textarea"},null,8,_),x.err?(s(),l("p",h,d(x.err),1)):c("",!0)],64))}});export{k as _};
