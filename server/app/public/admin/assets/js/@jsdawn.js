import{r as e,w as t,d as n,e as o,f as a,g as i,o as s,c as r,a as l,t as d,h as c,F as u}from"./@vue.js";const p=e=>e+"_"+(Date.now()+Math.floor(1e6*Math.random())),m=()=>{const e="undefined"!=typeof window?window:global;return e&&"tinymce"in e?e.tinymce:null};function g(e){return e?e.getContent():""}function f(e,t){t&&t.setContent(e)}function y(e,t=!0){e&&e.mode.set(t?"readonly":"design")}function b(e,t,n){return new Promise(((o,a)=>{let i,s,{images_upload_url:r,images_upload_credentials:l,custom_images_upload_header:d,custom_images_upload_param:c,custom_images_upload_callback:u}=e||{};i=new XMLHttpRequest,i.withCredentials=!!l,i.open("POST",r||""),d&&Object.keys(d).forEach((e=>{i.setRequestHeader(e,d[e])})),i.upload.onprogress=function(e){n(e.loaded/e.total*100)},i.onload=function(){if(403===i.status)return void a({message:"HTTP Error: "+i.status,remove:!0});if(i.status<200||i.status>=300)return void a("HTTP Error: "+i.status);let e=JSON.parse(i.responseText);if(!e)return void a("Invalid JSON: "+i.responseText);let t="function"==typeof u?u(e):e.location;t?o(t):a("Failed Path: location image path is error/empty")},i.onerror=function(){a("Image upload failed due to a XHR Transport error. Code: "+i.status)},s=new FormData,s.append("file",t.blob(),t.filename()),c&&Object.keys(c).forEach((e=>{s.append(e,c[e])})),i.send(s)}))}const v=(()=>{let e={status:{},loadedCallbacks:{}};const t=t=>{e.loadedCallbacks[t]&&(e.loadedCallbacks[t].forEach((e=>{"function"==typeof e.handler&&e.handler.call(e.scope)})),e.loadedCallbacks[t]=void 0)};return{load:(n,o,a)=>{o&&(e.loadedCallbacks[n]||(e.loadedCallbacks[n]=[]),e.loadedCallbacks[n].push({handler:o,scope:a||globalThis})),"LOADED"!==e.status[n]?"LOADING"!==e.status[n]&&(e.status[n]="LOADING",((e,t)=>{const n=document.createElement("script");n.id=p("tiny-script"),n.type="application/javascript",n.src=e,n.referrerPolicy="origin";const o=()=>{n.removeEventListener("load",o),t()};n.addEventListener("load",o),(document.head||document.body).appendChild(n)})(n,(()=>{e.status[n]="LOADED",t(n)}))):t(n)}}})(),h=["id"],_={key:0},C={name:"Vue3Tinymce"},k=Object.assign(C,{props:{modelValue:String,setting:{type:Object,default:()=>({})},setup:Function,disabled:Boolean,scriptSrc:String,debug:Boolean},emits:["update:modelValue","init","change"],setup(C,{expose:k,emit:w}){const O=C;let T=!0;const E=e({editor:null,id:p("tinymce"),err:""}),D=()=>{var e;return String(null!=(e=O.modelValue)?e:"")},j=(e,t,n)=>{O.debug&&console.log("来自：".concat(e.type," | \n ").concat(t," \n ").concat(n||"--"))},x=(e,t)=>{t||(t=E.editor);const n=g(t);j(e,n),w("update:modelValue",n),w("change",n)},S=()=>{var e;if(null===m())return void(E.err="tinymce is null");O.debug&&console.warn("vue3-tinymce 进入debug模式");let t={...O.setting,selector:"#".concat(E.id),content_style:(n=null==(e=O.setting)?void 0:e.content_style,"body{font-size: 14px;} img{padding: 0 2px;} "+(n||"")),setup:e=>{E.editor=e,O.setup&&O.setup(e),e.on("init",(()=>(e=>{f(D(),e),O.disabled&&"readonly"!==e.mode.get()&&y(e),e.on("change input undo redo",(t=>{x(t,e)})),w("init",e)})(e)))}};var n;O.setting.custom_images_upload&&(t.images_upload_handler=(...e)=>b.apply(null,[O.setting,...e])),m().init(t),T=!1};return t((()=>O.modelValue),((e,t)=>{if(E.editor&&E.editor.initialized&&t!==e&&e!==g(E.editor)){if(j({type:"propsChanged to setContent"},e,t),null===e)return function(e,t){if(t){if(t.resetContent)return t.resetContent(e);t.setContent(e),t.setDirty(!1),t.undoManager.clear()}}("",E.editor);f(D(),E.editor)}})),t((()=>O.disabled),(e=>{E.editor&&E.editor.initialized&&y(E.editor,e)})),k({id:E.id,editor:E.editor}),n((()=>{var e;if(null!==m())return void S();const t=null!=(e=O.scriptSrc)?e:"https://cdn.bootcdn.net/ajax/libs/tinymce/6.1.2/tinymce.min.js";v.load(t,S)})),o((()=>{T||S()})),a((()=>{var e;E.editor&&(null==(e=m())||e.remove("#".concat(E.id)))})),i((()=>{var e;E.editor&&(null==(e=m())||e.remove("#".concat(E.id)))})),(e,t)=>(s(),r(u,null,[l("div",{id:E.id,class:"tiny-textarea"},null,8,h),E.err?(s(),r("p",_,d(E.err),1)):c("",!0)],64))}});k.install=function(e){e.component("Vue3Tinymce",k)};export{k as _};
